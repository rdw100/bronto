@page "/bollinger"
@using AutoMapper
@using Bronto.Models.Api
@using Bronto.Models.Api.Chart
@using Bronto.Models.Enums
@using Bronto.Shared
@using Bronto.Stocks.Pwa.Components
@using Bronto.Stocks.Pwa.Interfaces
@using Bronto.Stocks.Pwa.Services
@using ScottPlot
@using ScottPlot.Blazor
@inject IChartService chartService

<h1>ScottPlot 5 in Blazor</h1>
<h2>Financial Plot</h2>
<h3>Bollinger Bands</h3>
<h3>Select a Stock Symbol</h3>

<StockCombo @bind-SelectedStockSymbol="SelectedStockSymbol" />

<p>Selected Stock Symbol: @_selectedStockSymbol</p>

@if (loadFailed) 
{
    <p><span style="color: red;">@errorMessage</span></p>
}
else if (ChartDataList is null)
{
    <p>Populating ...</p>
}
else if (!ChartDataList.Chart.Result.Any())
{
    <p>Loading ...</p>
}
else
{
    <p>Symbol: @ChartDataList.Chart.Result[0].Meta.Symbol</p>
    <p>Interval: @ChartDataList.Chart.Result[0].Meta.Range</p>
    <p>Updated: @UnixTimestampCalculator.ToDateTime(ChartDataList.Chart.Result[0].Meta.RegularMarketTime)</p>
    <p><button @onclick="()=>Clear()">Clear</button></p>
    <FluentStack HorizontalGap="10">
        <FluentButton Appearance="Appearance.Outline" OnClick="()=>LoadChart(_selectedStockSymbol, Interval, StockRange.ThreeMonths.GetStringValue())">3m</FluentButton>
        <FluentButton Appearance="Appearance.Outline" OnClick="()=>LoadChart(_selectedStockSymbol, Interval, StockRange.SixMonths.GetStringValue())">6m</FluentButton>
        <FluentButton Appearance="Appearance.Outline" OnClick="()=>LoadChart(_selectedStockSymbol, Interval, StockRange.OneYear.GetStringValue())">1y</FluentButton>
    </FluentStack>
}

<FluentDesignTheme @bind-Mode="@Mode" StorageName="theme" />

<BlazorPlot @ref=BlazorPlot Style="width: 400px; height: 300px;" />

@code {
    private bool loadFailed;
    private string errorMessage;
    private ChartResult ChartDataList { get; set; }
    private List<OHLC> prices { get; set; }
    private string _selectedStockSymbol = "AAPL";

    public string SelectedStockSymbol
    {
        get => _selectedStockSymbol;
        set
        {
            _selectedStockSymbol = value ?? "AAPL";
            _ = LoadChart(_selectedStockSymbol, Interval, Range);
        }
    }

    public string Interval { get; set; } = "1d";
    public string Range { get; set; } = StockRange.ThreeMonths.GetStringValue();
    public DesignThemeModes Mode { get; set; }
    
    BlazorPlot BlazorPlot { get; set; } = new();

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await LoadChart(_selectedStockSymbol, Interval, Range);
        }
    }

    // get and plot time series price data
    private async Task LoadChart(string symbol, string interval, string range)
    {
        try
        {
            BlazorPlot.Plot.Clear();
            loadFailed = false;
            await LoadData(symbol, interval, range);
            BlazorPlot.Refresh();
            StateHasChanged();
        }
        catch (Exception ex)
        {
            loadFailed = true;
            errorMessage = $"Error: {ex.Message}";
        }
    }

    private async Task LoadData(string symbol, string interval, string range)
    {
        prices = null;
        prices = await GetStocks(symbol, interval, range);

        BlazorPlot.Plot.Add.Candlestick(prices);
        BlazorPlot.Plot.Axes.DateTimeTicksBottom();

        // calculate Bollinger Bands
        ScottPlot.Finance.BollingerBands bb = new(prices, 20);

        // display center line (mean) as a solid line
        var sp1 = BlazorPlot.Plot.Add.Scatter(bb.Dates, bb.Means);
        sp1.MarkerSize = 0;
        sp1.Color = Colors.Navy;

        // display upper bands (positive variance) as a dashed line
        var sp2 = BlazorPlot.Plot.Add.Scatter(bb.Dates, bb.UpperValues);
        sp2.MarkerSize = 0;
        sp2.Color = Colors.Navy;
        sp2.LinePattern = LinePattern.Dotted;

        // display lower bands (positive variance) as a dashed line
        var sp3 = BlazorPlot.Plot.Add.Scatter(bb.Dates, bb.LowerValues);
        sp3.MarkerSize = 0;
        sp3.Color = Colors.Navy;
        sp3.LinePattern = LinePattern.Dotted;

        if (Mode == DesignThemeModes.Dark)
        {
            // change figure colors
            BlazorPlot.Plot.FigureBackground.Color = ScottPlot.Color.FromHex("#181818");
            BlazorPlot.Plot.DataBackground.Color = ScottPlot.Color.FromHex("#1f1f1f");

            // change axis and grid colors
            BlazorPlot.Plot.Axes.Color(ScottPlot.Color.FromHex("#d7d7d7"));
            BlazorPlot.Plot.Grid.MajorLineColor = ScottPlot.Color.FromHex("#404040");

            // change legend colors
            BlazorPlot.Plot.Legend.BackgroundColor = ScottPlot.Color.FromHex("#404040");
            BlazorPlot.Plot.Legend.FontColor = ScottPlot.Color.FromHex("#d7d7d7");
            BlazorPlot.Plot.Legend.OutlineColor = ScottPlot.Color.FromHex("#d7d7d7");
        };
    }

    protected async Task<List<OHLC>> GetStocks(string symbol, string interval, string range)
    {
        ChartDataList = await chartService.GetChartData(symbol, interval, range);

        @if (ChartDataList != null && ChartDataList.StatusCodeType == Enums.StockDataClientResponseStatus.Ok)
        {
            List<OHLC> ohlcList = ChartDataList.Chart.Result[0].Indicators.Quote[0].Open
                .Select((open, index) => new OHLC
                    {
                        Open = open,
                        High = ChartDataList.Chart.Result[0].Indicators.Quote[0].High[index],
                        Low = ChartDataList.Chart.Result[0].Indicators.Quote[0].Low[index],
                        Close = ChartDataList.Chart.Result[0].Indicators.Quote[0].Close[index],
                        DateTime = UnixTimestampCalculator.ToDateTime(ChartDataList.Chart.Result[0].Timestamp[index]),
                        TimeSpan = TimeSpan.FromDays(1.0)
                    })
                .ToList();

            prices = ohlcList;
        }
        else if (ChartDataList.StatusCodeType == Enums.StockDataClientResponseStatus.RateLimitExceeded)
        {
            loadFailed = true;
            errorMessage = $"Error: {ChartDataList.StatusCodeType} {ChartDataList.StatusMessage}";
            prices = null;
            StateHasChanged();
        }

        return prices;
    }

    private void Clear()
    {
        BlazorPlot.Plot.Clear();
        BlazorPlot.Refresh();
        loadFailed = false;
        prices = null;
        StateHasChanged();
    }
}